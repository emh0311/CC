-- Bedrock Quarry Turtle (with return-to-barrel)
-- Barrel must be directly behind starting position
-- Fuel in slot 1

local fuelSlot = 1
local trash = {
  ["minecraft:cobblestone"]=true,
  ["minecraft:dirt"]=true,
  ["minecraft:stone"]=true,
  ["minecraft:gravel"]=true,
  ["minecraft:granite"]=true,
  ["minecraft:diorite"]=true,
  ["create:gabbro"]=true,
}

local width, length
write("Width? ") width = tonumber(read())
write("Length? ") length = tonumber(read())

local depth = 0

local function refuel()
  if turtle.getFuelLevel() < 100 then
    turtle.select(fuelSlot)
    turtle.refuel(1)
  end
end

local function dumpInventory()
  for i=2,16 do
    local detail = turtle.getItemDetail(i)
    if detail then
      turtle.select(i)
      if trash[detail.name] then turtle.drop()
      else turtle.drop() end
    end
  end
end

local function goToChest()
  -- go up to y=0
  for i=1,depth do turtle.up() end
  turtle.turnLeft() turtle.turnLeft()
  dumpInventory()
  turtle.turnLeft() turtle.turnLeft()
  -- go back down to depth
  for i=1,depth do turtle.down() end
end

local function isFull()
  for i=2,16 do
    if turtle.getItemCount(i) == 0 then return false end
  end
  return true
end

local function mineLayer()
  for w=1,width do
    for l=1,length-1 do
      refuel()
      while turtle.detect() do turtle.dig() end
      turtle.forward()
      if isFull() then goToChest() end
    end
    if w < width then
      if w%2==1 then turtle.turnRight() else turtle.turnLeft() end
      while turtle.detect() do turtle.dig() end
      turtle.forward()
      if w%2==1 then turtle.turnRight() else turtle.turnLeft() end
    end
  end
  for i=1,length-1 do turtle.back() end
end

while true do
  mineLayer()
  if not turtle.down() then
    turtle.digDown()
    if not turtle.down() then
      print("Quarry complete.") break
    end
  end
  depth = depth + 1
end

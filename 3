-- bedrock_miner_safe.lua (fixed: no spin, safe descent, supports air & lava)

-- CONFIG
local fuelSlot = 1
local placeableSlot = 2  -- Reserved for safe blocks to plug lava / support
local trashBlocks = {
    ["minecraft:cobblestone"] = true,
    ["minecraft:dirt"] = true,
    ["minecraft:stone"] = true,
    ["minecraft:granite"] = true,
    ["minecraft:diorite"] = true
}

-- === Safe Down Movement ===
function safeDown()
    local success, data = turtle.inspectDown()

    -- Lava detected
    if success and data.name == "minecraft:lava" then
        print("Lava detected! Attempting to block...")
        turtle.select(placeableSlot)
        if turtle.placeDown() then
            print("Lava blocked.")
            sleep(0.5)
        else
            print("Failed to block lava. Aborting.")
            return false
        end
    end

    -- Solid block below â†’ dig until clear
    while turtle.detectDown() do
        turtle.digDown()
        sleep(0.3)
    end

    -- Try to move down
    if turtle.down() then
        return true
    else
        -- If air and can't move (rare), place a support block then move
        print("Air detected, placing support...")
        turtle.select(placeableSlot)
        if turtle.placeDown() and turtle.down() then
            return true
        else
            print("Failed to descend safely.")
            return false
        end
    end
end

-- === Fuel Handling ===
function refuelFromChest()
    turtle.select(fuelSlot)
    -- chest behind turtle
    if turtle.suck() then
        turtle.refuel()
        print("Refueled.")
    else
        print("No fuel found in back chest!")
    end
end

-- === Offload Handling ===
function offloadItems()
    for i = 3, 16 do
        turtle.select(i)
        if turtle.getItemCount(i) > 0 then
            turtle.drop() -- chest in front
        end
    end
end

function dropTrash()
    for i = 3, 16 do
        turtle.select(i)
        local item = turtle.getItemDetail()
        if item and trashBlocks[item.name] then
            turtle.drop()
        end
    end
end

function isInventoryFull()
    for i = 3, 16 do
        if turtle.getItemCount(i) == 0 then
            return false
        end
    end
    return true
end

-- === Return Logic ===
function returnToSurface(depth)
    for i = 1, depth do
        turtle.up()
    end
end

function returnToDepth(depth)
    for i = 1, depth do
        if not safeDown() then
            print("Failed to return to depth (blocked?).")
            return false
        end
    end
    return true
end

-- === Main Loop ===
function mineToBedrock()
    local depth = 0

    while true do
        -- Dig and move down
        if not safeDown() then
            print("Stopping due to unsafe conditions.")
            returnToSurface(depth)
            offloadItems()
            break
        end
        depth = depth + 1

        -- Mine block ahead (clear path)
        if turtle.detect() then
            turtle.dig()
        end

        -- Remove trash blocks
        dropTrash()

        -- Fuel check
        if turtle.getFuelLevel() < 50 then
            print("Low fuel, refueling...")
            returnToSurface(depth)
            refuelFromChest()
            offloadItems()
            if not returnToDepth(depth) then break end
        elseif isInventoryFull() then
            print("Inventory full, unloading...")
            returnToSurface(depth)
            offloadItems()
            if not returnToDepth(depth) then break end
        end

        -- Stop on bedrock
        local success, data = turtle.inspectDown()
        if success and data.name == "minecraft:bedrock" then
            print("Bedrock reached!")
            returnToSurface(depth)
            offloadItems()
            break
        end
    end
end

-- === Start ===
turtle.select(fuelSlot)
refuelFromChest()
mineToBedrock()
